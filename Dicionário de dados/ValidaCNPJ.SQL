USE [LUNA]
GO

/****** Object:  UserDefinedFunction [dbo].[ValidaCNPJ]    Script Date: 31/08/2024 15:49:08 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Loan
-- Create date: 31/08/2024
-- Description:	Valida CNPJ.
-- Como usar : SELECT dbo.ValidaCNPJ('11111111111111')
-- =============================================
CREATE FUNCTION [dbo].[ValidaCNPJ](@CNPJ VARCHAR(14))
RETURNS CHAR
AS
BEGIN
	DECLARE @SOMA INT
	DECLARE @RESTO INT
	DECLARE @DV1 INT
	DECLARE @DV2 INT
	DECLARE @I INT
	DECLARE @PESO VARCHAR(12) = '543298765432' -- '234567892345'
	DECLARE @RESULTADO CHAR(1)

	-- VERIFICA SE O CNPJ POSSÚI 14 DÍGITOS
	IF LEN(@CNPJ) <> 14 OR (@CNPJ LIKE REPLICATE(LEFT(@CNPJ, 1), 14))
		SET @RESULTADO = 'N'

	-- CALCULA PRIMEIRO DÍGITO VERIFICADOR
	SET @SOMA = 0
	SET @I = 1
	WHILE @I <= 12
	BEGIN
		SET @SOMA = @SOMA + CAST(SUBSTRING(@CNPJ, @I, 1) AS INT) * CAST(SUBSTRING(@PESO, @I, 1) AS INT)
		SET @I = @I + 1
	END

	SET @RESTO = @SOMA % 11
	SET @DV1 = CASE WHEN @RESTO < 2 THEN 0 ELSE 11 - @RESTO END

	-- CALCULA SEGUNDO DÍGITO VERIFICADOR
	SET @SOMA = 0
	SET @PESO = '6543298765432' -- '2345678923456'
	SET @I = 1
	WHILE @I <= 13
	BEGIN
		SET @SOMA = @SOMA + CAST(SUBSTRING(@CNPJ, @I, 1) AS INT) * CAST(SUBSTRING(@PESO, @I, 1) AS INT)
		SET @I = @I + 1
	END

	SET @RESTO = @SOMA % 11
	SET @DV2 = CASE WHEN @RESTO < 2 THEN 0 ELSE 11 - @RESTO END

	-- VALIDA OS DÍGITOS CONFORME OS DÍGITOS VERIFICADORES
	IF @DV1 = CAST(SUBSTRING(@CNPJ, 13, 1) AS INT) AND @DV2 = CAST(SUBSTRING(@CNPJ, 14, 1) AS INT)
		SET @RESULTADO = 'S'
	ELSE
		SET @RESULTADO = 'N'

	RETURN @RESULTADO
END
GO


