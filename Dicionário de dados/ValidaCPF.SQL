USE [LUNA]
GO

/****** Object:  UserDefinedFunction [dbo].[ValidaCPF]    Script Date: 31/08/2024 15:49:12 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Loan
-- Create date: 31/08/2024
-- Description:	Valida CPF.
-- Como usar : SELECT dbo.ValidaCPF('22222222222')
-- =============================================
CREATE FUNCTION [dbo].[ValidaCPF](@CPF VARCHAR(11))
RETURNS CHAR
AS
BEGIN
	DECLARE @SOMA INT
	DECLARE @RESTO INT
	DECLARE @DV1 INT
	DECLARE @DV2 INT
	DECLARE @I INT
	DECLARE @RESULTADO CHAR(1)

	-- VALIDA SE O CPF POSSUI 11 DÍGITOS
	IF LEN(@CPF) <> 11 OR @CPF LIKE REPLICATE(LEFT(@CPF, 1), 11)
		SET @RESULTADO = 'N'

	-- CALCULA PRIMEIRO DÍGITO VERIFICADOR
	SET @SOMA = 0
	SET @I = 1
	WHILE @I <= 9
	BEGIN
		SET @SOMA = @SOMA + CAST(SUBSTRING(@CPF, @I, 1) AS INT) * (11 - @I)
		SET @I = @I + 1
	END

	SET @RESTO = @SOMA % 11
	SET @DV1 = CASE WHEN @RESTO < 2 THEN 0 ELSE 11 - @RESTO END

	-- CALCULA SEGUNDO DÍGITO VERIFICADOR
	SET @SOMA = 0
	SET @I = 1
	WHILE @I <= 10
	BEGIN
		SET @SOMA = @SOMA + CAST(SUBSTRING(@CPF, @I, 1) AS INT) * (12 - @I)
		SET @I = @I + 1
	END

	SET @RESTO = @SOMA % 11
	SET @DV2 = CASE WHEN @RESTO < 2 THEN 0 ELSE 11 - @RESTO END

	-- VALIDA OS DÍGITOS COM OS DÍGITOS VERIFICADORES
	IF @DV1 = CAST(SUBSTRING(@CPF, 10, 1) AS INT) AND @DV2 = CAST(SUBSTRING(@CPF, 11, 1) AS INT)
		SET @RESULTADO = 'S'
	ELSE
		SET @RESULTADO = 'N'

	RETURN @RESULTADO
END
GO


